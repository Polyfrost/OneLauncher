datasource db {
  provider = "sqlite"
  url      = "file:dev.db"
}

generator client {
  provider      = "cargo prisma"
  output        = "../../prisma/src/prisma"
  module_path   = "prisma"
  client_format = "folder"
}

model Settings {
  id                Int     @id @unique @default(0)
  theme             String  @default("dark")
  hide_close_prompt Boolean @default(true)
  reduced_motion    Boolean @default(false)
  disable_analytics Boolean @default(false)
  debug_mode        Boolean @default(false)
  hide_on_launch    Boolean @default(false)
  force_fullscreen  Boolean @default(false)
  disable_discord   Boolean @default(false)
  release_channel   String  @default("stable")
  show_news         Boolean @default(true)

  custom_java_args String
  custom_env_args  String

  max_async_io_operations Int @default(10)
  max_async_fetches       Int @default(10)
  max_async_api_fetches   Int @default(25)

  resolution_x Int @default(854)
  resolution_y Int @default(480)

  memory_max Int @default(2048)
  memory_min Int @default(512)

  hook_pre     String?
  hook_wrapper String?
  hook_post    String?

  @@map("settings")
}

model JavaVersion {
  id            String        @id @unique @default(uuid())
  major_version Int
  full_version  String
  arch          String
  os            String
  type          String
  vendor        String
  path          String        @unique
  valid         Boolean       @default(true)
  profile       JavaProfile[]

  @@map("java_version")
}

model JavaProfile {
  name         String       @id
  system       Boolean      @default(false)
  java_version JavaVersion? @relation(fields: [java_id], references: [id], onDelete: SetNull)
  java_id      String?

  @@map("java_profile")
}

model MinecraftUser {
  uuid          String   @id
  active        Boolean  @default(false)
  username      String
  access_token  String
  refresh_token String
  expires       DateTime
  last_used     DateTime
  skin_id       String?

  @@unique([active])
  @@map("minecraft_user")
}

model Skin {
  id   String @id
  skin Bytes

  @@map("skin")
}

// TODO: packages/caching

model MinecraftDeviceToken {
  id             Int    @id @default(0)
  uuid           String
  private_key    String
  x              String
  y              String
  issue_instant  Int
  not_after      Int
  token          String
  display_claims String

  @@map("minecraft_device_token")
}

model Cluster {
  path            String       @id
  stage           String
  name            String
  icon_path       String?
  mc_version      String
  loader          String       @default("vanilla")
  loader_version  String?      @default("stable")
  group           ClusterGroup @relation(fields: [group_id], references: [id])
  group_id        Int
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
  played_at       DateTime?
  overall_played  Int          @default(0)
  recently_played Int          @default(0)

  override_java_path        String?
  override_custom_java_args String
  override_custom_env_args  String
  override_memory_max       Int?
  override_memory_min       Int?
  override_force_fullscreen Int?
  override_resolution_x     Int?
  override_resolution_y     Int?
  override_hook_pre         String?
  override_hook_wrapper     String?
  override_hook_post        String?
  processes                 Process[]

  @@map("cluster")
}

model ClusterGroup {
  id       Int       @id @default(autoincrement())
  name     String
  index    Int
  clusters Cluster[]

  @@map("cluster_group")
}

model Process {
  pid          Int      @id
  start_time   DateTime @default(now())
  name         String
  executable   String
  cluster_path String
  post_exit    String?
  cluster      Cluster  @relation(fields: [cluster_path], references: [path])

  @@unique([pid])
  @@index([cluster_path])
  @@map("process")
}

model VersionInfoCache {
  id           String   @id
  updated_at   DateTime @default(now()) @updatedAt
  version_info Bytes

  @@map("version_info_cache")
}

model PartialVersionInfoCache {
  id           String   @id
  updated_at   DateTime @default(now()) @updatedAt
  version_info Bytes

  @@map("partial_version_info")
}

model AssetsIndexCache {
  id           String   @id
  updated_at   DateTime @default(now()) @updatedAt
  assets_index Bytes

  @@map("assets_index_cache")
}

model PackageCache {
  id         String          @id @default(uuid())
  updated_at DateTime        @default(now()) @updatedAt
  sha512     String
  file_name  String
  file_size  Int
  disabled   Boolean
  meta_id    String
  meta       PackageMetadata @relation(fields: [meta_id], references: [id], onDelete: Restrict)

  @@unique([file_name])
  @@map("package_cache")
}

model PackageMetadata {
  id          String           @id
  updated_at  DateTime         @default(now()) @updatedAt
  name        String?
  package_id  String?
  version     String?
  description String?
  authors     String?
  loader      String
  // icon IconCache?
  managed     ManagedModCache?
  // inferred InferredModCache?
  cached      PackageCache[]

  @@map("package_metadata")
}

model ManagedModCache {
  meta_id      String          @id
  project_id   Int
  file_id      Int
  name         String
  version      String
  urlslug      String
  summary      String
  authors      String
  release_type Int
  update_paths String
  cached_at    DateTime
  meta         PackageMetadata @relation(fields: [meta_id], references: [id], onDelete: Cascade)

  @@map("managed_mod_cache")
}
